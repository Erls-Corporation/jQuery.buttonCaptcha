/*!
 * jQuery.buttonCaptcha - plugin that protects your site from robots using jQuery.
 * http://www.gobwas.com/bcaptcha
 * Version: 1.02.
 *
 * Copyright 2011, Sergey Kamardin.
 * Licensed under the MIT license.
 * http://www.opensource.org/licenses/mit-license.php
 *
 * Date: Mon Jun 6 19:03:51 2011 +0300.
 * Location: Moscow, Russia.
 * Contact: gobwas[a]gobwas.com
 */

(function(a){a.fn.buttonCaptcha=function(p){var d={codeWord:"gbws",codeZone:"com",hideButton:!0,hideCaptcha:!1,lockButton:!0,scrollToButton:!1,verifyInput:!0,verifyName:"gbws_captcha_input",captchaHeader:"Are you a robot?",captchaTip:'Drag letters from left to right, to get word "%code_word%". Thanks!',captchaUnlocked:"Unlocked!"};a.extend(d,p);d.captchaTip=d.captchaTip.replace("%code_word%","<b>"+d.codeWord+"</b>");d.letters=d.codeWord.length;var m=["a","b","c","d","e","f","g","h","i","j","k","l",
"m","n","o","p","q","r","s","t","u","v","w","x","y","z"],c={structure:{outer:{top:a("<div/>").attr("class","captcha_top"),lock:a("<div/>").attr("class","captcha_lock"),captcha:a("<div/>").attr("class","captcha_gbws")},inner:{left:a("<div/>").attr("class","captcha_left"),blue:a("<div/>").attr("class","captcha_blue").html('<div class="captcha_delshadow"></div>'),white:a("<div/>").attr("class","captcha_white"),right:a("<div/>").attr("class","captcha_right"),end:a("<div/>").css("clear","both")},buttons:{retake:a("<div/>").attr("class",
"captcha_retake"),showtip:a("<div/>").attr("class","captcha_showtip").html(d.captchaHeader)},contains:{tip:a("<div/>").attr("class","captcha_tip").html(d.captchaTip),end:a("<div/>").css("clear","both"),zone:a("<div/>").attr("class","captcha_zone")}},lettersDivs:[],lettersSprite:{}};c.lettersSprite=function(){var a={},c;for(c in m)a[m[c]]=c*-18;return a}();c.lettersDivs=function(){if(d.codeWord.match(/[a-zA-Z0-9]+/)!=null){for(var e=d.codeWord,k=[],f=0;f<e.length;f++){findLetter=e.charAt(f).toLowerCase();
var i=c.lettersSprite[findLetter],i=a("<div/>").attr("class","letter").attr("bcCode",e.charCodeAt(f)).css("background-position",i+"px 0");k.push(i)}return k}}();(function(){if(d.codeZone.match(/[a-zA-Z0-9]{2,4}/)!=null){var e=d.codeZone;a("<div/>").attr("class","zone_dot").appendTo(c.structure.contains.zone);for(var k=12,f=0;f<e.length;f++){findLetter=e.charAt(f).toLowerCase();var i=c.lettersSprite[findLetter];a("<div/>").attr("class","zone_letter").css("background-position",i+"px 0").appendTo(c.structure.contains.zone);
k+=18}c.structure.contains.zone.css("width",k+"px")}})();for(var l=0;l<this.length;l++)(function(e){function k(d,g){for(var f=a("<div/>").attr("id","letters_"+b.captchas).attr("class","letters"),h=[];h.length<c.lettersDivs.length;){var j=Math.floor(Math.random()*(c.lettersDivs.length-1-0+1))+0;a.inArray(j,h)==-1&&(a(c.lettersDivs[j]).clone().attr("id","letter_"+c.lettersDivs[j].attr("bccode")+"_"+j+"_"+b.captchas).appendTo(f).draggable({revert:!0,revertDuration:300,cursor:"pointer",cursorAt:{top:12,
left:9},containment:"#"+g,scroll:!1,snap:".basket",snapMode:"inner"}),h.push(j))}a(f).appendTo(d)}function f(f){var g=a("<div/>").attr("id","baskets_"+b.captchas).attr("class","baskets"),e;for(e in c.lettersDivs){var h=a("<div/>").attr("id","basket_"+c.lettersDivs[e].attr("bccode")+"_"+e+"_"+b.captchas).attr("class","basket");Number(e)!=c.lettersDivs.length-1&&h.css("border-right","none");a(h).droppable({hoverClass:"basket-hover",drop:function(c,f){if(!a(this).droppable("option","disabled")){var h=
a(f.draggable).clone().css({left:0,top:0});a(f.draggable).draggable({revert:!1}).css({left:0,top:0}).animate({width:0,opacity:0},600);a(this).droppable({disabled:!0}).attr("class","basket_closed").append(h);var e=a(f.draggable).attr("id"),e=e.split("_"),g=a(this).attr("id"),g=g.split("_");e[1]==g[1]&&e[3]==g[3]?(a(this).fadeOut(100,function(){a(this).fadeIn(500)}),a(h).attr("class","letter_blue"),b.goodLetters++):(a(this).effect("pulsate",100),a(h).attr("class","letter_red"));d.verifyInput===!0&&
(b.stepsLength++,b.steps[g[2]]=e[2],b.stepsLength==d.letters&&i());b.goodLetters==d.letters&&m()}}}).appendTo(g)}d.codeZone!=!1&&a(c.structure.contains.zone).clone().appendTo(g);a(c.structure.contains.end).clone().appendTo(g);a(g).appendTo(f).css("width",c.lettersDivs.length*18+c.lettersDivs.length*2+c.structure.contains.zone.css("width")+"px")}function i(){for(var c in b.steps)a(b.verify).val(a(b.verify).val()+d.codeWord.charAt(b.steps[c]))}function m(){d.lockButton===!0&&a(b.button).removeAttr("disabled");
d.hideCaptcha===!0?a(b.captcha).fadeOut(1E3,function(){d.hideButton===!0&&a(b.button).fadeIn(600,function(){d.scrollToButton===!0&&a.scrollTo(b.button,500)})}):(a("<div/>").attr("class","captcha_human").append(b.lock).appendTo(b.blue),b.lock.attr("class","captcha_unlock"),b.top.html(d.captchaUnlocked),b.retake.remove(),d.hideButton===!0&&a(b.button).fadeIn(300,function(){d.scrollToButton===!0&&a.scrollTo(b.button,500)}))}var b={captchas:l,button:e,captcha:null,verify:null,steps:[],stepsLength:0,goodLetters:0,
blue:null,white:null,captcha:null,lock:null,top:null,showTip:null,retake:null};(function(e){var g=a("<div/>").attr("class","captcha_gbws_wrap").attr("id","captcha_gbws_wrap_"+b.captchas),i=c.structure.outer.captcha.clone().attr("id","captcha_gbws_"+b.captchas),h=c.structure.buttons.showtip.clone().attr("id","captcha_gbws_top_showtip_"+b.captchas).bind("click",function(){j.toggle("blind",300)}),j=c.structure.contains.tip.clone().attr("id","captcha_gbws_top_tip_"+b.captchas),m=c.structure.outer.lock.clone(),
l=c.structure.outer.top.clone().attr("id","captcha_gbws_top_"+b.captchas).append(m).append(h).append(c.structure.contains.end.clone()).append(j),o=c.structure.buttons.retake.clone().bind("click",function(){for(var c=a(b.captcha).find(".letter, .letter_blue, .letter_red, .basket, .basket_closed"),d=0,e=0;e<c.length;e++)d+=150,function(b,d){setTimeout(function(){a(c[d]).stop().hide("shake",150,function(){a(c[d]).remove()})},b)}(d,e);setTimeout(function(){a("#"+a(b.blue).attr("id")+" .letters").remove();
a("#"+a(b.white).attr("id")+" .baskets").remove();f(b.white);k(b.blue);b.steps=[];b.stepsLength=0;b.goodLetters=0},d+150)});b.top=l;b.lock=m;b.showTip=h;b.retake=o;for(var n in c.structure.inner)if(h=a(c.structure.inner[n]).clone().attr("id","captcha_"+n+"_"+b.captchas).appendTo(i),n=="blue")b.blue=h,k(h,"captcha_gbws_"+b.captchas);else if(n=="white")b.white=h,h.append(o),f(h);l.appendTo(g);i.appendTo(g);c.structure.contains.end.clone().appendTo(g);g.insertBefore(e);j.toggle("blind",1);l.css("width",
i.width());g.find(" > *").disableSelection();b.captcha=g;if(d.verifyInput===!0&&a(b.button).parents("form:first").length>0)e=a("<input/>",{type:"hidden",name:d.verifyName,id:"input_gbws_"+b.captchas}).attr("class","input_gbws"),a(b.button).parents("form:first").append(e),b.verify=e})(b.button);d.hideButton===!0&&a(b.button).fadeOut(300);d.lockButton===!0&&a(b.button).attr("disabled","true")})(this[l]);return this}})(jQuery);
